/*! ElasticPress Autosuggest - v0.1.0
 * 
 * Copyright (c) 2017; * Licensed GPLv2+ */
!function(a){"use strict";function b(a){a.closest("form").submit()}function c(a,b){a.val(b)}function d(a,b){var c=null;return function(){var d=this,e=arguments;window.clearTimeout(c),c=window.setTimeout(function(){a.apply(d,e)},b)}}function e(a,b){"all"!==b&&"undefined"!=typeof b&&""!==b||(b="all");var c={suggest:{"post-suggest":{text:a,completion:{field:"post_title.completion"}},"term-suggest":{text:a,completion:{field:"term_suggest"}}}};return c}function f(b){var c=epas.host+"/"+epas.index+"/post/_search";return jQuery.support.cors=!0,a.ajax({url:c,type:"post",dataType:"json",crossDomain:!0,data:JSON.stringify(b)})}function g(d,e){var f,g,h=e.closest(".ep-autosuggest-container").find(".ep-autosuggest"),i=h.find(".autosuggest-list");for(i.empty(),a(".autosuggest-item").off(),d.length>0?h.show():h.hide(),f=0;f<d.length;++f){var j=d[f].toLowerCase();g='<li><span class="autosuggest-item" data-search="'+j+'">'+j+"</span></li>",a(g).appendTo(i)}a(".autosuggest-item").on("click",function(a){c(e,a.srcElement.innerText),b(e)}),e.off("keydown"),e.on("keydown",function(a){if(38!==a.keyCode&&40!==a.keyCode&&13!==a.keyCode);else{var d,f=e.closest(".ep-autosuggest-container").find(".autosuggest-list li"),g=f.filter(".selected");switch(a.keyCode){case 38:d=g.prev();break;case 40:f.hasClass("selected")||f.first().addClass("selected"),d=g.next();break;case 13:return f.hasClass("selected")?(c(e,g.find("span").text()),b(e),!1):void 0}if(d.is("li")&&(g.removeClass("selected"),d.addClass("selected")),38===a.keyCode)return!1}})}function h(){a(".autosuggest-list").empty(),a(".ep-autosuggest").hide()}if(epas.host&&""!==epas.host&&epas.index&&""!==epas.index){var i=a('input.elasticpress-autosuggest, input[type="search"]'),j=a('<div class="ep-autosuggest"><ul class="autosuggest-list"></ul></div>');i.each(function(b,c){var d=a('<div class="ep-autosuggest-container"></div>'),e=a(c);e.attr("autocomplete","off"),d.insertAfter(e);var f=e.siblings("label");e.closest("form").find(".ep-autosuggest-container").append(f).append(e),j.clone().insertAfter(e),e.trigger("elasticpress.input.moved")}),j.css({top:i.outerHeight()-1,"background-color":i.css("background-color")}),a(i).each(function(b,c){a(c).on("keyup keydown keypress",function(a){38!==a.keyCode&&40!==a.keyCode||a.preventDefault(),27===a.keyCode&&h()})}),i.each(function(b,c){var i=a(c);i.on("keyup",d(function(b){if(38!==b.keyCode&&40!==b.keyCode&&13!==b.keyCode&&27!==b.keyCode){var c,d,j=i.val(),k=epas.postType;j.length>=2?(c=e(j,k),d=f(c),d.done(function(b){if(b._shards.successful>0){var c=b.suggest["post-suggest"][0].options,d=b.suggest["term-suggest"][0].options,e=c.concat(d),f=[];a.each(e,function(b,c){a.inArray(c.text,f)===-1&&f.push(c.text)}),0===f.length?h():g(f,i)}else h()})):0===j.length&&h()}},100))})}}(jQuery);