/*! ElasticPress Autosuggest - v0.1.0
 * 
 * Copyright (c) 2017; * Licensed GPLv2+ */

!function(a){"use strict";function b(a){a.closest("form").submit()}function c(a,b){a.val(b)}function d(a,b){return window.location.href=b}function e(a,e){if("navigate"===epas.action)return d(a,e.dataset.url);c(a,e.innerText),b(a)}function f(a,b){var c=null;return function(){var d=this,e=arguments;window.clearTimeout(c),c=window.setTimeout(function(){a.apply(d,e)},b)}}function g(a,b){return"all"!==b&&void 0!==b&&""!==b||(b="all"),{suggest:{"post-suggest":{text:a,completion:{field:"post_title.completion"}},"term-suggest":{text:a,completion:{field:"term_suggest"}}}}}function h(b){var c=epas.host+"/"+epas.index+"/post/_search";return jQuery.support.cors=!0,a.ajax({url:c,type:"post",dataType:"json",crossDomain:!0,data:JSON.stringify(b)})}function i(b,c){var d,f,g=c.closest(".ep-autosuggest-container").find(".ep-autosuggest"),h=g.find(".autosuggest-list");for(h.empty(),a(".autosuggest-item").off(),b.length>0?g.show():g.hide(),d=0;d<b.length;++d){var i=b[d].text.toLowerCase();f='<li><span class="autosuggest-item" data-search="'+i+'" data-url="'+b[d].url+'">'+i+"</span></li>",a(f).appendTo(h)}a(".autosuggest-item").on("click",function(a){e(c,a.srcElement)}),c.off("keydown"),c.on("keydown",function(a){if(38!==a.keyCode&&40!==a.keyCode&&13!==a.keyCode);else{var b,d=c.closest(".ep-autosuggest-container").find(".autosuggest-list li"),f=d.filter(".selected");switch(a.keyCode){case 38:b=f.prev();break;case 40:d.hasClass("selected")?b=f.next():(d.first().addClass("selected"),b=d.first());break;case 13:return d.hasClass("selected")?(e(c,f.get(1)),!1):void 0}if(b.is("li")?(f.removeClass("selected"),b.addClass("selected")):d.removeClass("selected"),38===a.keyCode)return!1}})}function j(){a(".autosuggest-list").empty(),a(".ep-autosuggest").hide()}if(epas.host&&""!==epas.host&&epas.index&&""!==epas.index){var k=a('input.elasticpress-autosuggest, input[type="search"]'),l=a('<div class="ep-autosuggest"><ul class="autosuggest-list"></ul></div>');k.each(function(b,c){var d=a('<div class="ep-autosuggest-container"></div>'),e=a(c);e.attr("autocomplete","off"),d.insertAfter(e);var f=e.siblings("label");e.closest("form").find(".ep-autosuggest-container").append(f).append(e),l.clone().insertAfter(e),e.trigger("elasticpress.input.moved")}),l.css({top:k.outerHeight()-1,"background-color":k.css("background-color")}),a(k).each(function(b,c){a(c).on("keyup keydown keypress",function(a){38!==a.keyCode&&40!==a.keyCode||a.preventDefault(),27===a.keyCode&&j()})}),k.each(function(b,c){var d=a(c);d.on("keyup",f(function(b){if(38!==b.keyCode&&40!==b.keyCode&&13!==b.keyCode&&27!==b.keyCode){var c,e,f=d.val(),k=epas.postType;f.length>=2?(c=g(f,k),e=h(c),e.done(function(b){if(b._shards.successful>0){var c=b.suggest["post-suggest"][0].options,e=b.suggest["term-suggest"][0].options,f=c.concat(e),g=[],h=[];a.each(f,function(b,c){-1===a.inArray(c.text,g)&&(g.push(c.text),h.push({text:c.text,url:c._source.permalink}))}),0===h.length?j():i(h,d)}else j()})):0===f.length&&j()}},100))}),window.epasAPI={hideAutosuggestBox:j,updateAutosuggestBox:i,esSearch:h,buildSearchQuery:g}}}(jQuery);